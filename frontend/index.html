<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>TradeGate â€” Trade Tariff Calculator</title>
  <script type="module" src="auth.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --bg:           #0b0f1a;
      --bg-card:      #111827;
      --bg-input:     #1a2236;
      --border:       #1f2d45;
      --border-focus: #3b82f6;
      --text:         #e2e8f0;
      --text-dim:     #64748b;
      --text-label:   #94a3b8;
      --accent:       #3b82f6;
      --accent-dim:   #1d4ed8;
      --green:        #10b981;
      --red:          #ef4444;
      --amber:        #f59e0b;
      --radius:       10px;
      --shadow:       0 4px 24px rgba(0,0,0,0.4);
    }

    html { font-family: 'Inter', sans-serif; font-size: 15px; }
    body { background: var(--bg); color: var(--text); min-height: 100vh; }

    .page { max-width: 760px; margin: 0 auto; display: flex; flex-direction: column; gap: 1.5rem; padding: 2rem 1rem 0; }

    /* â”€â”€ Header â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    header { text-align: center; padding-bottom: 0.25rem; }
    .logo-row {
      display: flex; align-items: center; justify-content: center;
      gap: 0.55rem; margin-bottom: 0.4rem;
    }
    .logo-icon { font-size: 2rem; line-height: 1; }
    header h1 { font-size: 2rem; font-weight: 700; letter-spacing: -0.03em; }
    header h1 span { color: var(--accent); }
    .tagline {
      color: var(--text-dim); font-size: 0.85rem; margin-top: 0.35rem; letter-spacing: 0.01em;
    }
    .eyebrow {
      display: inline-flex; align-items: center; gap: 0.5rem;
      background: rgba(59,130,246,0.12); border: 1px solid rgba(59,130,246,0.25);
      color: #93c5fd; font-size: 0.7rem; font-weight: 600; letter-spacing: 0.1em;
      text-transform: uppercase; padding: 0.3rem 0.85rem; border-radius: 100px;
      margin-bottom: 1rem;
    }

    /* â”€â”€ Card â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .card {
      background: var(--bg-card); border: 1px solid var(--border);
      border-radius: var(--radius); padding: 1.75rem; box-shadow: var(--shadow);
    }
    .card-title {
      font-size: 0.72rem; font-weight: 600; letter-spacing: 0.1em;
      text-transform: uppercase; color: var(--text-dim); margin-bottom: 1.25rem;
      display: flex; align-items: center; gap: 0.5rem;
    }
    .card-title::before {
      content: ''; display: inline-block; width: 3px; height: 14px;
      background: var(--accent); border-radius: 2px;
    }

    /* â”€â”€ Form Grid â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1.1rem; }
    .form-group { display: flex; flex-direction: column; gap: 0.45rem; }
    .form-group.full { grid-column: 1 / -1; }

    label { font-size: 0.8rem; font-weight: 500; color: var(--text-label); }
    label .hint { font-weight: 400; color: var(--text-dim); }

    select, input[type="number"] {
      background: var(--bg-input); border: 1px solid var(--border);
      border-radius: 7px; color: var(--text); font-family: inherit;
      font-size: 0.9rem; padding: 0.65rem 0.85rem; width: 100%;
      outline: none; transition: border-color 0.15s;
      -moz-appearance: textfield;
    }
    select {
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='8' viewBox='0 0 12 8'%3E%3Cpath fill='%2364748b' d='M1 1l5 5 5-5'/%3E%3C/svg%3E");
      background-repeat: no-repeat; background-position: right 0.85rem center; padding-right: 2.2rem;
    }
    input[type="number"]::-webkit-inner-spin-button,
    input[type="number"]::-webkit-outer-spin-button { -webkit-appearance: none; }
    select:focus, input[type="number"]:focus { border-color: var(--border-focus); }
    select.error, input.error { border-color: var(--red); }

    /* â”€â”€ Radio Pills â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .condition-group { display: flex; gap: 0.6rem; flex-wrap: wrap; }
    .condition-group input[type="radio"] { display: none; }
    .condition-group label {
      flex: 1; min-width: 120px; text-align: center; padding: 0.6rem 0.5rem;
      background: var(--bg-input); border: 1px solid var(--border);
      border-radius: 7px; cursor: pointer; transition: all 0.15s;
      color: var(--text-label); font-size: 0.82rem; font-weight: 500;
    }
    .condition-group input[type="radio"]:checked + label {
      background: rgba(59,130,246,0.15); border-color: var(--accent); color: var(--text);
    }

    /* â”€â”€ Field errors â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .field-error { font-size: 0.75rem; color: var(--red); min-height: 1rem; }

    /* â”€â”€ Submit Button â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .btn-row { margin-top: 0.5rem; }
    .btn {
      display: flex; align-items: center; justify-content: center; gap: 0.6rem;
      background: var(--accent); color: #fff; border: none; border-radius: 7px;
      font-family: inherit; font-size: 0.9rem; font-weight: 600;
      padding: 0.78rem 1.5rem; width: 100%; cursor: pointer;
      transition: background 0.15s, opacity 0.15s;
    }
    .btn:hover:not(:disabled) { background: var(--accent-dim); }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .spinner {
      width: 16px; height: 16px; border: 2px solid rgba(255,255,255,0.3);
      border-top-color: #fff; border-radius: 50%;
      animation: spin 0.65s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* â”€â”€ Error Banner â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .error-banner {
      display: none; background: rgba(239,68,68,0.1); border: 1px solid rgba(239,68,68,0.3);
      color: #fca5a5; border-radius: var(--radius); padding: 0.85rem 1rem;
      font-size: 0.85rem; line-height: 1.5; margin-top: 1rem;
    }

    /* â”€â”€ Result Card â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #resultCard {
      display: none; opacity: 0; transform: translateY(12px);
      transition: opacity 0.3s ease, transform 0.3s ease;
    }
    #resultCard.visible { opacity: 1; transform: translateY(0); }

    .result-section { margin-bottom: 1.5rem; }
    .result-section:last-child { margin-bottom: 0; }

    .result-section-title {
      font-size: 0.7rem; font-weight: 600; letter-spacing: 0.1em;
      text-transform: uppercase; color: var(--text-dim); margin-bottom: 0.85rem;
    }

    /* Summary table */
    .summary-table { width: 100%; border-collapse: collapse; }
    .summary-table td {
      padding: 0.5rem 0; font-size: 0.88rem; border-bottom: 1px solid var(--border);
      vertical-align: top;
    }
    .summary-table tr:last-child td { border-bottom: none; }
    .summary-table td:first-child { color: var(--text-dim); width: 48%; }
    .summary-table td:last-child  { color: var(--text); font-weight: 500; text-align: right; }

    /* Condition colours in summary */
    .cond-normal       { color: var(--text); }
    .cond-preferential { color: var(--green); }
    .cond-penalty      { color: var(--red); }

    /* AI badge */
    .ai-badge-row { display: flex; align-items: center; gap: 0.6rem; margin-bottom: 0.85rem; }
    .ai-badge {
      display: inline-flex; align-items: center; gap: 0.35rem;
      font-size: 0.72rem; font-weight: 600; padding: 0.28rem 0.7rem;
      border-radius: 100px; letter-spacing: 0.04em;
    }
    .ai-badge.ai-on {
      background: rgba(16,185,129,0.15); border: 1px solid rgba(16,185,129,0.4);
      color: #6ee7b7;
      box-shadow: 0 0 10px rgba(16,185,129,0.15);
    }
    .ai-badge.ai-off {
      background: rgba(100,116,139,0.15); border: 1px solid rgba(100,116,139,0.3);
      color: var(--text-dim);
    }

    /* Tariff pair */
    .tariff-pair { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
    .tariff-box {
      background: var(--bg-input); border: 1px solid var(--border);
      border-radius: 8px; padding: 1rem 1.1rem;
    }
    .tariff-box .t-label { font-size: 0.72rem; color: var(--text-dim); margin-bottom: 0.35rem; }
    .tariff-box .t-value { font-size: 1.45rem; font-weight: 700; }
    .tariff-box.base .t-value { color: #60a5fa; }
    .tariff-box.eff  .t-value { color: var(--green); }

    /* Duty hero */
    .duty-hero {
      background: linear-gradient(135deg, rgba(59,130,246,0.12), rgba(16,185,129,0.08));
      border: 1px solid rgba(59,130,246,0.2); border-radius: 8px;
      padding: 1.25rem 1.5rem;
    }
    .duty-top {
      display: flex; align-items: center; justify-content: space-between;
      gap: 1rem; flex-wrap: wrap;
    }
    .duty-hero .d-label  { color: var(--text-dim); font-size: 0.82rem; font-weight: 500; }
    .duty-hero .d-value  { font-size: 2.2rem; font-weight: 700; color: var(--green); letter-spacing: -0.02em; }
    .duty-hero .d-source {
      font-size: 0.72rem; color: var(--text-dim); margin-top: 0.5rem;
      font-style: italic;
    }
    .engine-badge {
      font-size: 0.68rem; font-weight: 600; letter-spacing: 0.05em;
      text-transform: uppercase; background: rgba(59,130,246,0.15);
      color: #93c5fd; border: 1px solid rgba(59,130,246,0.25);
      padding: 0.25rem 0.65rem; border-radius: 100px;
    }

    /* â”€â”€ Nav â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    nav {
      display: flex; align-items: center; justify-content: space-between;
      padding: 0 2rem; height: 58px;
      background: var(--bg-card); border-bottom: 1px solid var(--border);
      position: sticky; top: 0; z-index: 10;
    }
    .nav-logo {
      display: flex; align-items: center; gap: 0.5rem; color: var(--text);
    }
    .nav-logo .icon { font-size: 1.4rem; line-height: 1; }
    .nav-logo span  { font-size: 1.1rem; font-weight: 700; letter-spacing: -0.02em; }
    .nav-logo span em { color: var(--accent); font-style: normal; }
    .nav-right { display: flex; align-items: center; gap: 0.75rem; }
    .nav-link {
      color: var(--text-label); text-decoration: none;
      font-size: 0.85rem; font-weight: 500; padding: 0.45rem 0.85rem;
      border-radius: 6px; border: 1px solid var(--border);
      transition: color 0.15s, border-color 0.15s, background 0.15s;
    }
    .nav-link:hover { color: var(--text); border-color: var(--border-focus); background: rgba(59,130,246,0.07); }
    .nav-signout {
      font-size: 0.85rem; font-weight: 500; padding: 0.45rem 0.85rem;
      border-radius: 6px; border: 1px solid var(--border);
      background: transparent; color: var(--text-dim);
      font-family: inherit; cursor: pointer;
      transition: color 0.15s, border-color 0.15s;
    }
    .nav-signout:hover { color: var(--red); border-color: var(--red); }

    /* â”€â”€ Pre-fill note â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .prefill-note {
      font-size: 0.75rem; color: var(--text-dim); margin-top: 0.3rem; display: none;
    }
    .prefill-note a { color: var(--accent); text-decoration: none; }
    .prefill-note a:hover { text-decoration: underline; }

    /* â”€â”€ Footer â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    footer {
      text-align: center; color: var(--text-dim); font-size: 0.75rem;
      padding: 1.5rem 0 1.5rem; border-top: 1px solid var(--border); margin-top: 0.5rem;
    }

    /* â”€â”€ Responsive â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    @media (max-width: 540px) {
      .form-grid { grid-template-columns: 1fr; }
      .form-group.full { grid-column: 1; }
      .tariff-pair { grid-template-columns: 1fr; }
      .duty-top { flex-direction: column; align-items: flex-start; }
      header h1 { font-size: 1.6rem; }
    }
  </style>
</head>
<body>
<nav>
  <div class="nav-logo">
    <span class="icon">ğŸŒ</span>
    <span>Trade<em>Gate</em></span>
  </div>
  <div class="nav-right">
    <a class="nav-link" href="/settings.html">âš™ Settings</a>
    <button class="nav-signout" id="nav-signout">Sign Out</button>
  </div>
</nav>
<div class="page">


  <!-- Header -->
  <header>
    <div class="eyebrow">8086 ASM Engine Â· Flask API Â· Gemini AI</div>
    <div class="logo-row">
      <span class="logo-icon">ğŸŒ</span>
      <h1>Trade<span>Gate</span></h1>
    </div>
    <p class="tagline">AI-Powered International Trade Tariff Calculator</p>
  </header>

  <!-- Form Card -->
  <div class="card">
    <div class="card-title">Transaction Details</div>
    <form id="tariffForm" novalidate autocomplete="off">

      <div class="form-grid">

        <div class="form-group">
          <label for="exporter">Exporter Country</label>
          <select id="exporter" required>
            <option value="" disabled selected>Select country</option>
            <option value="1">ğŸ‡ºğŸ‡¸ USA</option>
            <option value="2">ğŸ‡¨ğŸ‡³ China</option>
            <option value="3">ğŸ‡®ğŸ‡³ India</option>
            <option value="4">ğŸ‡©ğŸ‡ª Germany</option>
            <option value="5">ğŸ‡¯ğŸ‡µ Japan</option>
            <option value="6">ğŸ‡°ğŸ‡· South Korea</option>
            <option value="7">ğŸ‡»ğŸ‡³ Vietnam</option>
            <option value="8">ğŸ‡²ğŸ‡¾ Malaysia</option>
            <option value="9">ğŸ‡¬ğŸ‡§ UK</option>
            <option value="10">ğŸ‡«ğŸ‡· France</option>
          </select>
          <div class="field-error" id="exporterErr"></div>
          <div class="prefill-note" id="prefillNote">
            Pre-filled from your settings &mdash; <a href="/settings.html">Change</a>
          </div>
        </div>

        <div class="form-group">
          <label for="importer">Importer Country</label>
          <select id="importer" required>
            <option value="" disabled selected>Select country</option>
            <option value="1">ğŸ‡ºğŸ‡¸ USA</option>
            <option value="2">ğŸ‡¨ğŸ‡³ China</option>
            <option value="3">ğŸ‡®ğŸ‡³ India</option>
            <option value="4">ğŸ‡©ğŸ‡ª Germany</option>
            <option value="5">ğŸ‡¯ğŸ‡µ Japan</option>
            <option value="6">ğŸ‡°ğŸ‡· South Korea</option>
            <option value="7">ğŸ‡»ğŸ‡³ Vietnam</option>
            <option value="8">ğŸ‡²ğŸ‡¾ Malaysia</option>
            <option value="9">ğŸ‡¬ğŸ‡§ UK</option>
            <option value="10">ğŸ‡«ğŸ‡· France</option>
          </select>
          <div class="field-error" id="importerErr"></div>
        </div>

        <div class="form-group">
          <label for="category">Goods Category</label>
          <select id="category" required>
            <option value="" disabled selected>Select category</option>
            <option value="1">Electronics</option>
            <option value="2">Steel</option>
            <option value="3">Agriculture</option>
            <option value="4">Automobiles</option>
            <option value="5">Textiles</option>
            <option value="6">Chemicals</option>
            <option value="7">Machinery</option>
            <option value="8">Pharmaceuticals</option>
          </select>
          <div class="field-error" id="categoryErr"></div>
        </div>

        <div class="form-group">
          <label for="declared">Declared Value <span class="hint">(USD)</span></label>
          <input type="number" id="declared" min="1" step="1" placeholder="e.g. 500000" required />
          <div class="field-error" id="declaredErr"></div>
        </div>

        <div class="form-group full">
          <label>Trade Condition</label>
          <div class="condition-group">
            <input type="radio" name="condition" id="cond1" value="1" checked />
            <label for="cond1">Normal</label>
            <input type="radio" name="condition" id="cond2" value="2" />
            <label for="cond2">Preferential &minus;5%</label>
            <input type="radio" name="condition" id="cond3" value="3" />
            <label for="cond3">Penalty +10%</label>
          </div>
        </div>

      </div>

      <div class="btn-row">
        <button class="btn" type="submit" id="submitBtn">Calculate Duty</button>
      </div>

    </form>
    <div class="error-banner" id="errorBanner"></div>
  </div>

  <!-- Result Card -->
  <div class="card" id="resultCard">
    <div class="card-title">Calculation Result</div>

    <!-- Trade Summary -->
    <div class="result-section">
      <div class="result-section-title">Trade Summary</div>
      <table class="summary-table">
        <tr><td>Exporter</td><td id="rExporter">â€”</td></tr>
        <tr><td>Importer</td><td id="rImporter">â€”</td></tr>
        <tr><td>Goods Category</td><td id="rCategory">â€”</td></tr>
        <tr><td>Declared Value</td><td id="rDeclared">â€”</td></tr>
        <tr><td>Trade Condition</td><td id="rCondition">â€”</td></tr>
      </table>
    </div>

    <!-- Tariff Section -->
    <div class="result-section">
      <div class="result-section-title">Applied Tariff</div>
      <div class="ai-badge-row">
        <span class="ai-badge" id="aiBadge">â€”</span>
      </div>
      <div class="tariff-pair">
        <div class="tariff-box base">
          <div class="t-label">Base Tariff</div>
          <div class="t-value" id="rBase">â€”</div>
        </div>
        <div class="tariff-box eff">
          <div class="t-label">Effective Tariff</div>
          <div class="t-value" id="rEff">â€”</div>
        </div>
      </div>
    </div>

    <!-- Duty Payable -->
    <div class="result-section">
      <div class="result-section-title">Duty Payable</div>
      <div class="duty-hero">
        <div class="duty-top">
          <div>
            <div class="d-label">Total Duty Amount</div>
            <div class="d-value" id="rDuty">â€”</div>
          </div>
          <span class="engine-badge">âš™ DOSBox ASM</span>
        </div>
        <div class="d-source" id="rSource">â€”</div>
      </div>
    </div>

  </div>

  <footer>TradeGate &copy; 2026 &nbsp;|&nbsp; Powered by 8086 ASM + Gemini AI</footer>

</div>

<script type="module">
  // â”€â”€ Auth gate & country pre-fill â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  await new Promise(r => {
    if (window.Auth) return r();
    const t = setInterval(() => { if (window.Auth) { clearInterval(t); r(); } }, 20);
  });

  await Auth.requireAuth();

  const savedCountry = await Auth.getCountry();
  if (savedCountry) {
    const sel = document.getElementById('exporter');
    sel.value = String(savedCountry);
    document.getElementById('prefillNote').style.display = 'block';
  }

  document.getElementById('nav-signout').addEventListener('click', () => Auth.signOut());
</script>

<script>
  const COUNTRY_NAMES = {
    1:'USA', 2:'China', 3:'India', 4:'Germany', 5:'Japan',
    6:'South Korea', 7:'Vietnam', 8:'Malaysia', 9:'UK', 10:'France'
  };
  const CATEGORY_NAMES = {
    1:'Electronics', 2:'Steel', 3:'Agriculture', 4:'Automobiles',
    5:'Textiles', 6:'Chemicals', 7:'Machinery', 8:'Pharmaceuticals'
  };

  const form        = document.getElementById('tariffForm');
  const submitBtn   = document.getElementById('submitBtn');
  const errorBanner = document.getElementById('errorBanner');
  const resultCard  = document.getElementById('resultCard');

  form.querySelectorAll('select, input').forEach(el => {
    el.addEventListener('change', hideResult);
    el.addEventListener('input',  hideResult);
  });

  function hideResult() {
    resultCard.classList.remove('visible');
    setTimeout(() => { resultCard.style.display = 'none'; }, 300);
  }
  function showError(msg) {
    errorBanner.textContent = msg;
    errorBanner.style.display = 'block';
  }
  function clearError() {
    errorBanner.style.display = 'none';
    errorBanner.textContent = '';
  }
  function setFieldError(id, msg) { document.getElementById(id).textContent = msg; }
  function clearFieldErrors() {
    ['exporterErr','importerErr','categoryErr','declaredErr'].forEach(id =>
      document.getElementById(id).textContent = ''
    );
    ['exporter','importer','category','declared'].forEach(id =>
      document.getElementById(id).classList.remove('error')
    );
  }
  function setLoading(on) {
    submitBtn.disabled = on;
    submitBtn.innerHTML = on
      ? '<span class="spinner"></span>Calculatingâ€¦'
      : 'Calculate Duty';
  }
  function usd(n) {
    return new Intl.NumberFormat('en-US', {
      style: 'currency', currency: 'USD', maximumFractionDigits: 0
    }).format(n);
  }

  // Inline same-country check
  ['exporter','importer'].forEach(id => {
    document.getElementById(id).addEventListener('change', () => {
      const exp = document.getElementById('exporter').value;
      const imp = document.getElementById('importer').value;
      if (exp && imp && exp === imp) {
        setFieldError('importerErr', 'Importer cannot be the same as exporter.');
        document.getElementById('importer').classList.add('error');
        document.getElementById('exporter').classList.add('error');
      } else {
        setFieldError('importerErr', '');
        setFieldError('exporterErr', '');
        document.getElementById('importer').classList.remove('error');
        document.getElementById('exporter').classList.remove('error');
      }
    });
  });

  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    clearError();
    clearFieldErrors();

    const exporter       = parseInt(document.getElementById('exporter').value);
    const importer       = parseInt(document.getElementById('importer').value);
    const category       = parseInt(document.getElementById('category').value);
    const declared_value = parseInt(document.getElementById('declared').value);
    const condition      = parseInt(document.querySelector('input[name="condition"]:checked').value);

    let hasErr = false;
    if (!exporter)       { setFieldError('exporterErr','Please select an exporter.'); document.getElementById('exporter').classList.add('error'); hasErr = true; }
    if (!importer)       { setFieldError('importerErr','Please select an importer.'); document.getElementById('importer').classList.add('error'); hasErr = true; }
    if (!category)       { setFieldError('categoryErr','Please select a category.');  document.getElementById('category').classList.add('error'); hasErr = true; }
    if (!declared_value || declared_value < 1) { setFieldError('declaredErr','Enter a positive integer value.'); document.getElementById('declared').classList.add('error'); hasErr = true; }
    if (exporter && importer && exporter === importer) {
      setFieldError('importerErr','Importer cannot be the same as exporter.');
      document.getElementById('importer').classList.add('error');
      document.getElementById('exporter').classList.add('error');
      hasErr = true;
    }
    if (hasErr) return;

    setLoading(true);
    hideResult();

    try {
      const res  = await fetch('/calculate', {
        method:  'POST',
        headers: { 'Content-Type': 'application/json' },
        body:    JSON.stringify({ exporter, importer, category, declared_value, condition }),
      });
      const data = await res.json();

      if (!res.ok) { showError(data.error ?? `Server error ${res.status}`); return; }

      // Trade summary
      document.getElementById('rExporter').textContent = COUNTRY_NAMES[exporter]  ?? exporter;
      document.getElementById('rImporter').textContent = COUNTRY_NAMES[importer]  ?? importer;
      document.getElementById('rCategory').textContent = CATEGORY_NAMES[category] ?? category;
      document.getElementById('rDeclared').textContent = usd(declared_value);

      // Condition with colour
      const condEl = document.getElementById('rCondition');
      condEl.className = '';
      if (condition === 1) { condEl.textContent = 'Normal';            condEl.className = 'cond-normal'; }
      else if (condition === 2) { condEl.textContent = 'Preferential â–¼5%'; condEl.className = 'cond-preferential'; }
      else                 { condEl.textContent = 'Penalty â–²10%';     condEl.className = 'cond-penalty'; }

      // AI badge
      const badge = document.getElementById('aiBadge');
      if (data.ai_assisted) {
        badge.textContent = 'âœ¨ AI-Assisted Rate';
        badge.className   = 'ai-badge ai-on';
      } else {
        badge.textContent = 'ğŸ“Š Standard Rate';
        badge.className   = 'ai-badge ai-off';
      }

      // Tariff values
      document.getElementById('rBase').textContent = data.base_tariff      ?? 'â€”';
      document.getElementById('rEff').textContent  = data.effective_tariff ?? 'â€”';

      // Duty + source note
      document.getElementById('rDuty').textContent   = usd(data.duty_payable ?? 0);
      document.getElementById('rSource').textContent = data.ai_assisted
        ? 'Rate sourced live via Gemini AI'
        : 'Rate from standard tariff table';

      // Animate in
      resultCard.style.display = 'block';
      requestAnimationFrame(() =>
        requestAnimationFrame(() => resultCard.classList.add('visible'))
      );
      resultCard.scrollIntoView({ behavior: 'smooth', block: 'nearest' });

    } catch (err) {
      showError('Could not reach the backend. Is the Flask server running on port 5000?');
    } finally {
      setLoading(false);
    }
  });
</script>
</body>
</html>
